# OAuth Token Validator

A little package that helps the app to work as an oAuth2 client in contrast to Laravel Passport which is used to create an oAuth2 server.

## 1. Installation

In the *composer.json* add this repository so the package can be found:
```
"repositories": [
    {
        "type": "vcs",
        "url": "git@github.com:lara-lab/oauth-token-validator.git"
     }
],
```

The the project directory run (it should be able to find the package now):
```
composer require lara-lab/oauth-token-validator
```

## 2. Configuration

The package requires to be able to read and create new users. It might be necessary to add this in the *app\Providers\AppServiceProvider.php*:
```
use Franklin\OAuth2Client\Interfaces\UserRepository;
...
...
public function register()
{
...
...    
    // Define which UserRepository implementation should be used
    $this->app->bind(
        UserRepository::class,
        EloquentUserRepository::class
    );
...
...
}        
```

The *app/Repositories/EloquentUserRepository.php* MUST implement the UserRepository interface:
```
...
use Franklin\BaseRepository\Interfaces\RepositoryInterface;
use Franklin\BaseRepository\Repositories\BaseRepository;
...
class UserRepository extends BaseRepository implements RepositoryInterface
...

```

In the *config/app.php* add this line to the application service providers - it must be put AFTER the main ap service provider:
```
...
App\Providers\AppServiceProvider::class,
...
Franklin\OAuth2Client\Providers\OAuth2ClientServiceProvider::class
```

Publish the config file (and optionally Swagger schemas):
```
php artisan vendor:publish --tag=oauth2client-config
```
```
php artisan vendor:publish --tag=oauth2client-errors4xx
```
```
php artisan vendor:publish --tag=oauth2client-errors5xx
```
```
php artisan vendor:publish --tag=oauth2client-token
```

and configure the oAuth2 server data which is now in the *config/oauth2client.php*. The required data needs to be obtained from the oAuth2 server as obviously the functionality
of the package depends on the correct oAuth2 client created.

Add the new middlewares in your *app/Http/Kernel.php* to your routeMiddleware:
```
'validateToken' => \Franklin\OAuth2Client\Http\Middleware\ValidateTokenMiddleware::class
'validateLogoutToken' => \Franklin\OAuth2Client\Http\Middleware\ValidateLogoutTokenMiddleware::class
```

The last step is to add the exception thrown by the package to the list of exceptions which should not be reported.

In the *app\Exceptions\Handler.php* add:
```
...
use Franklin\OAuth2Client\Exceptions\InvalidTokenException;
...
```

And then in the *$dontReport* class property:
```
protected $dontReport = [
        ...
        ...
        \Franklin\OAuth2Client\Exceptions\InvalidTokenException::class,
    ];
```

Run the new migrations (required to store refresh tokens):
```
php artisan migrate
```

Add a scheduled job to clean expired tokens in the *app/Console/Kernel.php*:
```
...
protected $commands = [
...
    CleanUserTokensCommand::class
...        
];
...
```

```
...
protected function schedule(Schedule $schedule)
{
    ...
    $schedule->command('oauth2client:clean-tokens')->hourly();
    ...
}
...    
```

## 3. Usage

Now that middleware can be added to routes to protect resources.

```
Route::group(['prefix' => 'v1', 'middleware' => ['validateToken']], function () {
    Route::get('/programs', ['as' => 'api.programs.get', 'uses' => 'ProgramController@index']);
});
```

## API Documentation

The API documentation is generated by Swagger (https://github.com/zircote/swagger-php) from the files in the 
*routes* folder and stored inside the *documentation* folder. To generate this file, run this command:
```
./vendor/bin/openapi ./swagger ./src/routes -o ./swagger/oauth2client-api.yml
```
In order to see nice HTML for that yaml file, copy its content and paste it here:
http://swagger.dev.nccgroup.com/